/*
 * Copyright 2008-2009 the original author or authors.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.more.hypha.anno.assembler;
import java.lang.annotation.Annotation;
import org.more.core.error.LostException;
import org.more.hypha.AbstractBeanDefine;
import org.more.hypha.anno.KeepWatchParser;
import org.more.hypha.aop.AopService;
import org.more.hypha.aop.assembler.AopService_Impl;
import org.more.hypha.define.anno.Aop;
import org.more.hypha.define.anno.AopInformed;
import org.more.hypha.define.anno.Bean;
import org.more.hypha.define.aop.AopConfig;
import org.more.hypha.define.aop.AopDefineInformed;
import org.more.hypha.define.aop.AopPointcut;
import org.more.hypha.define.aop.AopPointcutType;
import org.more.hypha.xml.XmlDefineResource;
/**
 * 该bean用于解析aop的注解配置，取消该类不会影响到anno的服务提供。只不过会导致无法解析bean的aop注解声明。
 * @version 2010-10-14
 * @author 赵永春 (zyc@byshell.org)
 */
class Watch_Aop implements KeepWatchParser {
    public void process(Object target, Annotation annoData, XmlDefineResource resource) {
        Class<?> beanType = (Class<?>) target;
        Bean bean = beanType.getAnnotation(Bean.class);
        if (bean == null)
            return;
        AopService aopPlugin = (AopService) resource.getFlash().getAttribute(AopService_Impl.ServiceName);
        // ID
        String id = bean.id();
        if (id.equals("") == true) {
            StringBuffer idb = new StringBuffer();
            String logicPackage = bean.logicPackage();
            if (logicPackage.equals("") == true)
                logicPackage = beanType.getPackage().getName();
            idb.append(logicPackage);
            idb.append(".");
            String name = bean.name();
            if (name.equals("") == true)
                name = beanType.getSimpleName();
            idb.append(name);
            id = idb.toString();
        }
        //1.获取aop注解
        BeanDefine define = resource.getBeanDefine(id);
        Aop aop = beanType.getAnnotation(Aop.class);
        if (aop == null)
            return;
        //2.检查useConfig属性。
        AopConfig aopConfig = null;
        String var = aop.useConfig();
        if (var.equals("") == false) {
            aopConfig = aopPlugin.getAopDefine(var);
            if (aopConfig == null)
                throw new LostException("找不到名称为[" + var + "]的Aop配置。");
            aopPlugin.setAop(define, aopConfig);
            return;
        }
        //3.解析aop注解
        aopConfig = new AopConfig();
        aopConfig.setAopMode(aop.mode());
        //defaultPointcut
        AopPointcut aoppoint = new AopPointcut();
        aoppoint.setExpression(aop.defaultPointcut());
        aopConfig.setDefaultPointcutDefine(aoppoint);
        //informeds
        AopInformed[] informeds = aop.informeds();
        for (AopInformed informed : informeds) {
            String refBean = informed.refBean();
            String pointcut = informed.pointcut();
            AopPointcutType pointType = informed.type();
            //切入点定义
            AopPointcut aoppoint_item = new AopPointcut();
            aoppoint.setExpression(pointcut);
            //监听器定义
            AopDefineInformed informedDefine = new AopDefineInformed();
            informedDefine.setRefBean(refBean);
            informedDefine.setPointcutType(pointType);
            informedDefine.setRefPointcut(aoppoint_item);
            //
            aopConfig.addInformed(informedDefine);
        }
        //4.注册
        aopPlugin.setAop(define, aopConfig);
    }
}